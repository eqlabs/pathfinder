name: End-to-End Test

on:
  workflow_dispatch:

env:
  TARGET_DIR: /data/cache/pathfinder-target

jobs:
  compile:
    runs-on: self-hosted
    env:
      CARGO_TERM_COLOR: always
      MLIR_SYS_190_PREFIX: "/usr/lib/llvm-19"
      LLVM_SYS_191_PREFIX: "/usr/lib/llvm-19"
      TABLEGEN_190_PREFIX: "/usr/lib/llvm-19"
    steps:
      - uses: actions/checkout@v4
      - uses: rui314/setup-mold@v1
      # - uses: Swatinem/rust-cache@v2
        # with:
        #   save-if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'schedule' }}
      - name: Compile with all features enabled
        run: timeout 30m cargo build --release --all-features --locked --bin pathfinder --target-dir ${{ env.TARGET_DIR }}
      - name: Upload pathfinder binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: pathfinder
          path: ${{ env.TARGET_DIR }}/release/pathfinder
          if-no-files-found: error

  run:
    runs-on: self-hosted
    needs: compile
    steps:
      - uses: actions/checkout@v4
      - name: Download pathfinder binary
        uses: actions/download-artifact@v4
        with:
          name: pathfinder
      - name: Run Pathfinder
        run: |
          set -e
          set -x
          ./target/release/pathfinder --version
